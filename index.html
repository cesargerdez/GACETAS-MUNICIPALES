<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GACETAS MUNICIPALES - Gestor de Documentos</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--box-shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 1.8rem;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 20px;
            position: relative;
        }

        .search-container input {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-container input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-container input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }

        .search-container i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
        }

        .user-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: transparent;
            color: white;
            border: 1px solid white;
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        main {
            padding: 2rem 0;
        }

        .upload-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }

        .upload-area {
            border: 2px dashed #bdc3c7;
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .upload-area h3 {
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
        }

        .upload-area p {
            color: #7f8c8d;
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .file-card {
            background-color: white;
            border-radius: var(--border-radius);
            overflow: visible;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            cursor: pointer;
            height: fit-content;
        }

        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .file-preview {
            height: 160px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .file-preview .file-icon {
            font-size: 3rem;
            color: var(--primary-color);
        }

        /* Portadas estilizadas para diferentes tipos de archivos */
        .cover-preview {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .pdf-cover {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .doc-cover {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .image-cover {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .cover-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .cover-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cover-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .cover-corner {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.7rem;
        }

        .file-info {
            padding: 1.2rem;
            position: relative;
            z-index: 2;
            background: white;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95rem;
        }

        .file-meta {
            display: flex;
            justify-content: space-between;
            color: #7f8c8d;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .file-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid #f0f0f0;
        }

        .file-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary-color);
            transition: var(--transition);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .file-actions button:hover {
            background-color: rgba(52, 152, 219, 0.1);
            transform: scale(1.1);
        }

        .file-actions button.delete:hover {
            color: var(--accent-color);
            background-color: rgba(231, 76, 60, 0.1);
        }

        /* NOTAS FLOTANTES MEJORADAS - M√ÅS GRANDES Y LEGIBLES */
        .file-floating-note {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px) scale(0.95);
            background: rgba(44, 62, 80, 0.98);
            color: white;
            padding: 22px;
            border-radius: 14px;
            width: 480px;
            max-width: 95vw;
            z-index: 1000;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* Nota flotante activa - se queda fija */
        .file-floating-note.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0) scale(1);
            pointer-events: auto;
        }

        .file-card:nth-child(odd) .file-floating-note.active {
            transform: translateY(-50%) translateX(0) scale(1);
        }

        .file-card:nth-child(even) .file-floating-note.active {
            transform: translateY(-50%) translateX(0) scale(1);
        }

        .file-card:first-child .file-floating-note.active,
        .file-card:nth-child(2) .file-floating-note.active {
            transform: translateX(-50%) translateY(0) scale(1);
        }

        .file-card:last-child .file-floating-note.active,
        .file-card:nth-last-child(2) .file-floating-note.active {
            transform: translateX(-50%) translateY(0) scale(1);
        }

        /* Bot√≥n de cerrar para notas flotantes */
        .note-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .note-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .note-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            padding-bottom: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-right: 40px;
        }

        .note-icon {
            font-size: 1.5rem;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .note-title {
            font-weight: 600;
            font-size: 1.1rem;
            flex: 1;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .edit-description-btn {
            background: rgba(255, 255, 255, 0.2) !important;
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .edit-description-btn:hover {
            background: rgba(255, 255, 255, 0.3) !important;
            transform: scale(1.05);
        }

        .note-content {
            line-height: 1.6;
            margin-bottom: 16px;
            max-height: 180px;
            overflow-y: auto;
            padding-right: 8px;
            font-size: 0.95rem;
        }

        .note-content::-webkit-scrollbar {
            width: 6px;
        }

        .note-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .note-content::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        /* Editor de descripci√≥n */
        .description-editor {
            width: 100%;
            height: 140px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            line-height: 1.5;
        }

        .description-editor:focus {
            outline: none;
            border-color: var(--success-color);
        }

        .edit-controls {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            justify-content: flex-end;
        }

        .save-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .save-btn:hover {
            background: #27ae60;
            transform: scale(1.05);
        }

        .cancel-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .cancel-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .note-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
            color: #bdc3c7;
            margin-bottom: 14px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            overflow: hidden;
        }

        .meta-item i {
            font-size: 0.8rem;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .meta-item span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .note-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .tag {
            background: rgba(52, 152, 219, 0.3);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            border: 1px solid rgba(52, 152, 219, 0.5);
            white-space: nowrap;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
            grid-column: 1 / -1;
        }

        .no-results i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #bdc3c7;
        }

        /* Modal para vista previa */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 95%;
            height: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 2px solid #f0f0f0;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px 12px 0 0;
            flex-shrink: 0;
        }

        .modal-header h3 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin: 0;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #7f8c8d;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .close-modal:hover {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--accent-color);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 0;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            background: #f8f9fa;
        }

        .preview-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            box-sizing: border-box;
        }

        .modal-body img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .modal-body img:hover {
            transform: scale(1.02);
        }

        .modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background: white;
        }

        .modal-body .file-icon {
            font-size: 8rem;
            color: var(--primary-color);
            margin-bottom: 2rem;
        }

        .file-preview-message {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 500px;
        }

        .file-preview-message p {
            font-size: 1.1rem;
            color: var(--dark-color);
            margin: 0;
            line-height: 1.6;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--accent-color);
        }

        /* Login Modal */
        .login-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .login-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .login-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .login-header h2 {
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .login-header p {
            color: #7f8c8d;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .login-btn:hover {
            background-color: #2980b9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .user-role {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .user-role.admin {
            background: rgba(231, 76, 60, 0.3);
        }

        .user-role.user {
            background: rgba(46, 204, 113, 0.3);
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        footer {
            background-color: var(--secondary-color);
            color: white;
            text-align: center;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }

        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .search-container {
                max-width: 100%;
                margin: 10px 0;
            }
            
            .file-list {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1.5rem;
            }
            
            .file-floating-note {
                width: 380px;
                padding: 18px;
                position: fixed;
                left: 50% !important;
                right: auto !important;
                top: 50% !important;
                bottom: auto !important;
                transform: translate(-50%, -50%) scale(0.95) !important;
            }
            
            .file-floating-note.active {
                transform: translate(-50%, -50%) scale(1) !important;
            }
            
            .file-actions button {
                padding: 8px 10px;
                font-size: 0.9rem;
            }

            .edit-description-btn {
                padding: 6px 10px;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            .file-list {
                grid-template-columns: 1fr;
            }
            
            .file-floating-note {
                width: 90vw;
                max-width: 350px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Modal de Login -->
    <div class="login-modal" id="loginModal">
        <div class="login-content">
            <div class="login-header">
                <h2>Iniciar Sesi√≥n</h2>
                <p>Ingrese sus credenciales para acceder al sistema</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" placeholder="Ingrese su usuario" required>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" placeholder="Ingrese su contrase√±a" required>
                </div>
                <button type="submit" class="login-btn">Iniciar Sesi√≥n</button>
            </form>
            <div style="margin-top: 20px; font-size: 0.9rem; color: #7f8c8d;">
                <p><strong>Usuarios de prueba:</strong></p>
                <p>Administrador: admin / admin123</p>
                <p>Usuario: usuario / usuario123</p>
            </div>
        </div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-file-alt"></i>
                    <h1>GACETAS MUNICIPALES</h1>
                </div>
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Buscar documentos...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="user-actions" id="userActions">
                    <!-- Se llenar√° din√°micamente con informaci√≥n del usuario -->
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="upload-section" id="uploadSection">
            <h2>Subir Documentos</h2>
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Arrastra y suelta archivos aqu√≠</h3>
                <p>o haz clic para seleccionar archivos</p>
                <p class="file-types">Soporta: PDF, DOC, DOCX, JPG, PNG, GIF</p>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
            </div>
            <button class="btn btn-primary" id="uploadBtn">
                <i class="fas fa-upload"></i> Subir Archivos
            </button>
        </section>

        <section class="files-section">
            <h2>Mis Documentos</h2>
            <div class="file-list" id="fileList">
                <!-- Los archivos se cargar√°n aqu√≠ din√°micamente -->
            </div>
            <div class="no-results" id="noResults" style="display: none;">
                <i class="fas fa-search"></i>
                <h3>No se encontraron resultados</h3>
                <p>Intenta con otros t√©rminos de b√∫squeda</p>
            </div>
        </section>
    </main>

    <!-- Modal para vista previa -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Vista Previa</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="preview-container" id="previewContainer">
                    <!-- El contenido se cargar√° aqu√≠ din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div class="toast" id="toast"></div>

    <footer>
        <div class="container">
            <p>&copy; 2025 CASA DEL HISTORIADOR. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
        // =============================================
        // BASE DE DATOS - IndexedDB
        // =============================================
        const DB_NAME = 'GacetasMunicipalesDB';
        const DB_VERSION = 1;
        const FILES_STORE = 'files';
        const USERS_STORE = 'users';
        
        let db = null;
        let currentUser = null;

        // Inicializar la base de datos
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    
                    // Crear almac√©n de archivos
                    if (!database.objectStoreNames.contains(FILES_STORE)) {
                        const filesStore = database.createObjectStore(FILES_STORE, { keyPath: 'id', autoIncrement: true });
                        filesStore.createIndex('name', 'name', { unique: false });
                        filesStore.createIndex('type', 'type', { unique: false });
                        filesStore.createIndex('date', 'date', { unique: false });
                    }
                    
                    // Crear almac√©n de usuarios
                    if (!database.objectStoreNames.contains(USERS_STORE)) {
                        const usersStore = database.createObjectStore(USERS_STORE, { keyPath: 'id', autoIncrement: true });
                        usersStore.createIndex('username', 'username', { unique: true });
                        
                        // Insertar usuarios por defecto
                        const defaultUsers = [
                            { id: 1, username: 'admin', password: 'admin123', role: 'admin', name: 'Administrador' },
                            { id: 2, username: 'usuario', password: 'usuario123', role: 'user', name: 'Usuario Regular' }
                        ];
                        
                        defaultUsers.forEach(user => {
                            usersStore.add(user);
                        });
                    }
                };
            });
        }

        // Guardar archivo en la base de datos
        function saveFileToDB(file) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([FILES_STORE], 'readwrite');
                const store = transaction.objectStore(FILES_STORE);
                const request = store.add(file);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Obtener todos los archivos de la base de datos
        function getAllFilesFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([FILES_STORE], 'readonly');
                const store = transaction.objectStore(FILES_STORE);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Actualizar archivo en la base de datos
        function updateFileInDB(file) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([FILES_STORE], 'readwrite');
                const store = transaction.objectStore(FILES_STORE);
                const request = store.put(file);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Eliminar archivo de la base de datos
        function deleteFileFromDB(fileId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([FILES_STORE], 'readwrite');
                const store = transaction.objectStore(FILES_STORE);
                const request = store.delete(fileId);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Verificar credenciales de usuario
        function authenticateUser(username, password) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([USERS_STORE], 'readonly');
                const store = transaction.objectStore(USERS_STORE);
                const index = store.index('username');
                const request = index.get(username);
                
                request.onsuccess = () => {
                    const user = request.result;
                    if (user && user.password === password) {
                        resolve(user);
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = () => reject(request.error);
            });
        }

        // =============================================
        // SISTEMA DE AUTENTICACI√ìN
        // =============================================
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const userActions = document.getElementById('userActions');
        const uploadSection = document.getElementById('uploadSection');

        // Mostrar/ocultar elementos seg√∫n el rol del usuario
        function updateUIForUser() {
            if (currentUser) {
                // Actualizar informaci√≥n del usuario en el header
                userActions.innerHTML = `
                    <div class="user-info">
                        <span>Bienvenido, ${currentUser.name}</span>
                        <span class="user-role ${currentUser.role}">${currentUser.role === 'admin' ? 'Administrador' : 'Usuario'}</span>
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                        </button>
                    </div>
                `;
                
                // Mostrar/ocultar secci√≥n de subida seg√∫n el rol
                if (currentUser.role === 'user') {
                    uploadSection.style.display = 'none';
                } else {
                    uploadSection.style.display = 'block';
                }
                
                // Agregar event listener al bot√≥n de cerrar sesi√≥n
                document.getElementById('logoutBtn').addEventListener('click', logout);
                
                // Ocultar modal de login
                loginModal.style.display = 'none';
            } else {
                // Mostrar modal de login si no hay usuario autenticado
                loginModal.style.display = 'flex';
                userActions.innerHTML = '';
                uploadSection.style.display = 'none';
            }
        }

        // Funci√≥n de login
        async function login(username, password) {
            try {
                const user = await authenticateUser(username, password);
                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    updateUIForUser();
                    loadFilesFromDB();
                    showToast(`Bienvenido, ${user.name}`);
                    return true;
                } else {
                    showToast('Credenciales incorrectas', true);
                    return false;
                }
            } catch (error) {
                console.error('Error en login:', error);
                showToast('Error al iniciar sesi√≥n', true);
                return false;
            }
        }

        // Funci√≥n de logout
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateUIForUser();
            showToast('Sesi√≥n cerrada correctamente');
        }

        // Verificar si hay una sesi√≥n activa al cargar la p√°gina
        function checkExistingSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUIForUser();
                loadFilesFromDB();
            } else {
                updateUIForUser();
            }
        }

        // =============================================
        // GESTI√ìN DE ARCHIVOS
        // =============================================
        let files = [];

        // Cargar archivos desde la base de datos
        async function loadFilesFromDB() {
            try {
                files = await getAllFilesFromDB();
                renderFiles(files);
            } catch (error) {
                console.error('Error al cargar archivos:', error);
                showToast('Error al cargar los archivos', true);
            }
        }

        // Elementos del DOM
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileList = document.getElementById('fileList');
        const searchInput = document.getElementById('searchInput');
        const noResults = document.getElementById('noResults');
        const previewModal = document.getElementById('previewModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const previewContainer = document.getElementById('previewContainer');
        const toast = document.getElementById('toast');

        // Variables para el editor de descripciones
        let currentEditingFileId = null;
        let originalDescription = '';

        // Variables globales para control de notas flotantes
        let activeNote = null;
        let noteCloseTimeouts = {};

        // Funci√≥n para mostrar notificaciones toast
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '') + ' show';
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Funci√≥n para activar una nota flotante
        function activateNote(fileId) {
            // Cerrar nota activa anterior si existe
            if (activeNote && activeNote !== fileId) {
                deactivateNote(activeNote);
            }
            
            // Limpiar timeout de cierre si existe
            if (noteCloseTimeouts[fileId]) {
                clearTimeout(noteCloseTimeouts[fileId]);
                delete noteCloseTimeouts[fileId];
            }
            
            const fileCard = document.querySelector(`.file-card[data-id="${fileId}"]`);
            if (fileCard) {
                const note = fileCard.querySelector('.file-floating-note');
                note.classList.add('active');
                activeNote = fileId;
            }
        }

        // Funci√≥n para desactivar una nota flotante
        function deactivateNote(fileId) {
            const fileCard = document.querySelector(`.file-card[data-id="${fileId}"]`);
            if (fileCard) {
                const note = fileCard.querySelector('.file-floating-note');
                note.classList.remove('active');
                
                if (activeNote === fileId) {
                    activeNote = null;
                }
            }
        }

        // Funci√≥n para cerrar nota flotante con delay (para evitar cierre accidental)
        function scheduleNoteClose(fileId) {
            // Limpiar timeout anterior si existe
            if (noteCloseTimeouts[fileId]) {
                clearTimeout(noteCloseTimeouts[fileId]);
            }
            
            noteCloseTimeouts[fileId] = setTimeout(() => {
                deactivateNote(fileId);
                delete noteCloseTimeouts[fileId];
            }, 300);
        }

        // Funci√≥n para cancelar cierre programado
        function cancelNoteClose(fileId) {
            if (noteCloseTimeouts[fileId]) {
                clearTimeout(noteCloseTimeouts[fileId]);
                delete noteCloseTimeouts[fileId];
            }
        }

        // Funci√≥n para activar el modo edici√≥n en la nota flotante
        function enableDescriptionEdit(fileId, currentDescription) {
            // Verificar permisos
            if (currentUser.role !== 'admin') {
                showToast('No tiene permisos para editar descripciones', true);
                return;
            }
            
            currentEditingFileId = fileId;
            originalDescription = currentDescription;
            
            // Asegurarse de que la nota est√© activa
            activateNote(fileId);
            
            const fileCard = document.querySelector(`.file-card[data-id="${fileId}"]`);
            const noteContent = fileCard.querySelector('.note-content');
            const editBtn = fileCard.querySelector('.edit-description-btn');
            const closeBtn = fileCard.querySelector('.note-close-btn');
            
            // Ocultar botones temporalmente durante la edici√≥n
            editBtn.style.display = 'none';
            closeBtn.style.display = 'none';
            
            // Reemplazar el contenido con un textarea editable
            noteContent.innerHTML = `
                <textarea class="description-editor">${currentDescription}</textarea>
                <div class="edit-controls">
                    <button class="save-btn">üíæ Guardar</button>
                    <button class="cancel-btn">‚ùå Cancelar</button>
                </div>
            `;

            // Agregar event listeners a los botones
            const saveBtn = noteContent.querySelector('.save-btn');
            const cancelBtn = noteContent.querySelector('.cancel-btn');
            const textarea = noteContent.querySelector('.description-editor');

            saveBtn.addEventListener('click', () => saveDescriptionEdit(fileId, textarea.value));
            cancelBtn.addEventListener('click', cancelDescriptionEdit);
            
            // Enfocar el textarea
            textarea.focus();
            
            // Permitir guardar con Ctrl+Enter
            textarea.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    saveDescriptionEdit(fileId, textarea.value);
                }
            });

            // Prevenir cierre de la nota durante la edici√≥n
            cancelNoteClose(fileId);
        }

        // Funci√≥n para guardar la descripci√≥n editada
        async function saveDescriptionEdit(fileId, newDescription) {
            const file = files.find(f => f.id === fileId);
            if (file) {
                file.description = newDescription.trim() || originalDescription;
                
                try {
                    await updateFileInDB(file);
                    showToast('‚úÖ Descripci√≥n actualizada correctamente');
                } catch (error) {
                    console.error('Error al guardar descripci√≥n:', error);
                    showToast('Error al guardar la descripci√≥n', true);
                }
            }
            currentEditingFileId = null;
            originalDescription = '';
            
            // Volver a renderizar para mostrar los cambios
            renderFiles(files);
        }

        // Funci√≥n para cancelar la edici√≥n
        function cancelDescriptionEdit() {
            currentEditingFileId = null;
            originalDescription = '';
            
            // Volver a renderizar para restaurar el estado original
            renderFiles(files);
            showToast('Edici√≥n cancelada');
        }

        // Funcionalidad de arrastrar y soltar
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary-color)';
            uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#bdc3c7';
            uploadArea.style.backgroundColor = 'transparent';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#bdc3c7';
            uploadArea.style.backgroundColor = 'transparent';
            
            if (e.dataTransfer.files.length) {
                handleFiles(e.dataTransfer.files);
            }
        });

        // Abrir selector de archivos al hacer clic en el √°rea de subida
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Manejar archivos seleccionados
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFiles(fileInput.files);
            }
        });

        // Subir archivos al hacer clic en el bot√≥n
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // Funci√≥n para manejar archivos seleccionados
        async function handleFiles(selectedFiles) {
            // Verificar permisos
            if (currentUser.role !== 'admin') {
                showToast('No tiene permisos para subir archivos', true);
                return;
            }
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                
                // Verificar tipo de archivo
                const fileType = getFileType(file.name);
                
                // Convertir archivo a base64 para almacenamiento
                const fileContent = await readFileAsDataURL(file);
                
                // Crear objeto de archivo
                const newFile = {
                    name: file.name,
                    type: fileType,
                    size: formatFileSize(file.size),
                    date: new Date().toISOString().split('T')[0],
                    preview: fileType === 'jpg' || fileType === 'png' || fileType === 'gif' ? 'image' : fileType,
                    content: fileContent,
                    description: `üìÑ ${file.name.replace(/\.[^/.]+$/, "")} - Archivo ${fileType.toUpperCase()} subido el ${new Date().toLocaleDateString()}.`,
                    coverColor: getCoverClass(fileType),
                    tags: getAutoTags(fileType, file.name),
                    category: getAutoCategory(fileType, file.name),
                    author: currentUser.name,
                    uploadedBy: currentUser.id
                };
                
                try {
                    // Guardar en la base de datos
                    const fileId = await saveFileToDB(newFile);
                    newFile.id = fileId;
                    
                    // Agregar a la lista de archivos
                    files.unshift(newFile);
                } catch (error) {
                    console.error('Error al guardar archivo:', error);
                    showToast(`Error al guardar ${file.name}`, true);
                }
            }
            
            // Volver a renderizar la lista
            renderFiles(files);
            
            // Limpiar input
            fileInput.value = '';
            
            // Mostrar mensaje de √©xito
            showToast(`Se han agregado ${selectedFiles.length} archivo(s) correctamente.`);
        }

        // Funci√≥n para leer archivo como Data URL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Funci√≥n para determinar el tipo de archivo
        function getFileType(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            return extension;
        }

        // Funci√≥n para obtener la clase CSS para la portada
        function getCoverClass(fileType) {
            const coverClasses = {
                pdf: "pdf-cover",
                doc: "doc-cover",
                docx: "doc-cover",
                jpg: "image-cover",
                png: "image-cover",
                gif: "image-cover"
            };
            
            return coverClasses[fileType] || "doc-cover";
        }

        // Funci√≥n para obtener el icono de portada
        function getCoverIcon(fileType) {
            const coverIcons = {
                pdf: "fas fa-file-pdf",
                doc: "fas fa-file-word",
                docx: "fas fa-file-word",
                jpg: "fas fa-file-image",
                png: "fas fa-file-image",
                gif: "fas fa-file-image"
            };
            
            return coverIcons[fileType] || "fas fa-file";
        }

        // Funci√≥n para obtener el icono de nota
        function getNoteIcon(fileType) {
            const noteIcons = {
                pdf: "fas fa-file-pdf",
                doc: "fas fa-file-word",
                docx: "fas fa-file-word",
                jpg: "fas fa-file-image",
                png: "fas fa-file-image",
                gif: "fas fa-file-image"
            };
            
            return noteIcons[fileType] || "fas fa-file";
        }

        // Funci√≥n para generar t√≠tulo corto para portada
        function generateShortTitle(filename) {
            const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
            if (nameWithoutExt.length <= 20) {
                return nameWithoutExt;
            }
            return nameWithoutExt.substring(0, 17) + '...';
        }

        // Funci√≥n para formatear el tama√±o del archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Funciones auxiliares para categorizaci√≥n autom√°tica
        function getAutoTags(fileType, filename) {
            const baseTags = ["Subido", "Nuevo"];
            const nameLower = filename.toLowerCase();
            
            // Tags basados en tipo de archivo
            const typeTags = {
                pdf: ["Documento", "PDF"],
                doc: ["Documento", "Texto"],
                docx: ["Documento", "Texto"],
                jpg: ["Imagen", "Foto"],
                png: ["Imagen", "Gr√°fico"],
                gif: ["Imagen", "Animaci√≥n"]
            };

            // Tags basados en palabras clave del nombre
            const contentTags = [];
            if (nameLower.includes('informe') || nameLower.includes('reporte')) contentTags.push("Reporte");
            if (nameLower.includes('contrato') || nameLower.includes('acuerdo')) contentTags.push("Legal");
            if (nameLower.includes('manual') || nameLower.includes('gu√≠a')) contentTags.push("Manual");
            if (nameLower.includes('presentaci√≥n') || nameLower.includes('ppt')) contentTags.push("Presentaci√≥n");
            if (nameLower.includes('logo') || nameLower.includes('branding')) contentTags.push("Dise√±o");
            if (nameLower.includes('diagrama') || nameLower.includes('flujo')) contentTags.push("Diagrama");
            if (nameLower.includes('financiero') || nameLower.includes('presupuesto')) contentTags.push("Finanzas");

            return [...baseTags, ...(typeTags[fileType] || []), ...contentTags.slice(0, 2)];
        }

        function getAutoCategory(fileType, filename) {
            const nameLower = filename.toLowerCase();
            
            // Categor√≠as basadas en contenido
            if (nameLower.includes('informe') || nameLower.includes('reporte') || nameLower.includes('an√°lisis')) 
                return "Reportes";
            if (nameLower.includes('contrato') || nameLower.includes('legal') || nameLower.includes('acuerdo')) 
                return "Legal";
            if (nameLower.includes('manual') || nameLower.includes('gu√≠a') || nameLower.includes('instrucciones')) 
                return "Documentaci√≥n";
            if (nameLower.includes('presentaci√≥n') || nameLower.includes('ppt') || nameLower.includes('estrategia')) 
                return "Presentaciones";
            if (nameLower.includes('logo') || nameLower.includes('branding') || nameLower.includes('dise√±o')) 
                return "Dise√±o";
            if (nameLower.includes('diagrama') || nameLower.includes('flujo') || nameLower.includes('proceso')) 
                return "Diagramas";
            if (nameLower.includes('financiero') || nameLower.includes('presupuesto') || nameLower.includes('contabilidad')) 
                return "Finanzas";

            // Categor√≠as basadas en tipo de archivo
            const typeCategories = {
                pdf: "Documentos",
                doc: "Documentos", 
                docx: "Documentos",
                jpg: "Im√°genes",
                png: "Im√°genes",
                gif: "Im√°genes"
            };

            return typeCategories[fileType] || "General";
        }

        // Funci√≥n para renderizar archivos
        function renderFiles(filesToRender) {
            if (filesToRender.length === 0) {
                fileList.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            
            fileList.innerHTML = filesToRender.map(file => `
                <div class="file-card" data-id="${file.id}" data-name="${file.name.toLowerCase()}">
                    <!-- Nota flotante -->
                    <div class="file-floating-note">
                        <button class="note-close-btn" title="Cerrar nota" data-id="${file.id}">√ó</button>
                        <div class="note-header">
                            <div class="note-icon">
                                <i class="${getNoteIcon(file.type)}"></i>
                            </div>
                            <div class="note-title">${file.name}</div>
                            ${currentUser.role === 'admin' ? `
                                <button class="edit-description-btn" 
                                        title="Editar descripci√≥n" 
                                        data-id="${file.id}">
                                    ‚úèÔ∏è Editar
                                </button>
                            ` : ''}
                        </div>
                        <div class="note-content">
                            ${file.description}
                        </div>
                        <div class="note-meta">
                            <div class="meta-item">
                                <i class="fas fa-hashtag"></i>
                                <span>${file.category}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-user"></i>
                                <span>${file.author}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>${file.date}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-weight-hanging"></i>
                                <span>${file.size}</span>
                            </div>
                        </div>
                        <div class="note-tags">
                            ${file.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="file-preview">
                        ${file.preview === 'image' 
                            ? `<img src="${file.content}" alt="${file.name}">`
                            : `
                                <div class="cover-preview ${file.coverColor}">
                                    <i class="cover-icon ${getCoverIcon(file.type)}"></i>
                                    <div class="cover-title">${generateShortTitle(file.name)}</div>
                                    <div class="cover-subtitle">${file.type.toUpperCase()}</div>
                                    <div class="cover-corner">${file.size}</div>
                                </div>
                            `
                        }
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">
                            <span>${file.type.toUpperCase()}</span>
                            <span>${file.size}</span>
                        </div>
                        <div class="file-actions">
                            <button class="download" title="Descargar" data-id="${file.id}">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="preview" title="Vista previa" data-id="${file.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="share" title="Compartir" data-id="${file.id}">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            ${currentUser.role === 'admin' ? `
                                <button class="delete" title="Eliminar" data-id="${file.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Agregar event listeners a los botones principales
            addButtonEventListeners();
            
            // Agregar event listeners a los botones de edici√≥n de descripci√≥n (solo para admin)
            if (currentUser.role === 'admin') {
                addDescriptionEditListeners();
            }
            
            // Agregar event listeners para el comportamiento de notas flotantes
            addNoteBehaviorListeners();
        }

        // Funci√≥n para agregar event listeners a los botones principales
        function addButtonEventListeners() {
            // Botones de descarga
            document.querySelectorAll('.file-actions .download').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fileId = parseInt(e.currentTarget.getAttribute('data-id'));
                    downloadFile(fileId);
                });
            });
            
            // Botones de vista previa
            document.querySelectorAll('.file-actions .preview').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fileId = parseInt(e.currentTarget.getAttribute('data-id'));
                    previewFile(fileId);
                });
            });
            
            // Botones de compartir
            document.querySelectorAll('.file-actions .share').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fileId = parseInt(e.currentTarget.getAttribute('data-id'));
                    shareFile(fileId);
                });
            });
            
            // Botones de eliminar (solo para admin)
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.file-actions .delete').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const fileId = parseInt(e.currentTarget.getAttribute('data-id'));
                        deleteFile(fileId);
                    });
                });
            }
        }

        // Funci√≥n para agregar event listeners a los botones de edici√≥n
        function addDescriptionEditListeners() {
            document.querySelectorAll('.edit-description-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fileId = parseInt(e.currentTarget.getAttribute('data-id'));
                    const file = files.find(f => f.id === fileId);
                    if (file) {
                        enableDescriptionEdit(fileId, file.description);
                    }
                });
            });
        }

        // Funci√≥n para agregar event listeners al comportamiento de notas flotantes
        function addNoteBehaviorListeners() {
            // Event listeners para las tarjetas de archivo (activar nota)
            document.querySelectorAll('.file-card').forEach(card => {
                const fileId = parseInt(card.getAttribute('data-id'));
                
                // Activar nota al hacer hover en la tarjeta
                card.addEventListener('mouseenter', () => {
                    activateNote(fileId);
                });
                
                // Programar cierre al salir de la tarjeta (pero no si el mouse va a la nota)
                card.addEventListener('mouseleave', (e) => {
                    // Verificar si el mouse se fue a la nota flotante
                    const relatedTarget = e.relatedTarget;
                    const note = card.querySelector('.file-floating-note');
                    
                    if (!note.contains(relatedTarget)) {
                        scheduleNoteClose(fileId);
                    }
                });
            });

            // Event listeners para las notas flotantes (mantener activas)
            document.querySelectorAll('.file-floating-note').forEach(note => {
                const fileId = parseInt(note.querySelector('.note-close-btn').getAttribute('data-id'));
                
                // Cancelar cierre cuando el mouse entra a la nota
                note.addEventListener('mouseenter', () => {
                    cancelNoteClose(fileId);
                });
                
                // Cerrar nota cuando el mouse sale de la nota
                note.addEventListener('mouseleave', (e) => {
                    const relatedTarget = e.relatedTarget;
                    const card = note.closest('.file-card');
                    
                    // Solo cerrar si el mouse no fue a la tarjeta principal
                    if (!card.contains(relatedTarget)) {
                        scheduleNoteClose(fileId);
                    }
                });
            });

            // Event listeners para los botones de cerrar
            document.querySelectorAll('.note-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fileId = parseInt(btn.getAttribute('data-id'));
                    deactivateNote(fileId);
                });
            });
        }

        // Funci√≥n para descargar archivo
        function downloadFile(fileId) {
            const file = files.find(f => f.id === fileId);
            if (!file) {
                showToast('Error: Archivo no encontrado', true);
                return;
            }
            
            try {
                // Crear un enlace temporal para descargar
                const link = document.createElement('a');
                link.href = file.content;
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast(`Descargando: ${file.name}`);
            } catch (error) {
                showToast('Error al descargar el archivo', true);
                console.error('Error al descargar:', error);
            }
        }

        // Funci√≥n para vista previa
        function previewFile(fileId) {
            const file = files.find(f => f.id === fileId);
            if (!file) {
                showToast('Error: Archivo no encontrado', true);
                return;
            }
            
            modalTitle.textContent = `Vista Previa: ${file.name}`;
            
            // Limpiar contenido previo
            previewContainer.innerHTML = '';
            
            try {
                // Mostrar contenido seg√∫n el tipo de archivo
                if (file.preview === 'image') {
                    const img = document.createElement('img');
                    img.src = file.content;
                    img.alt = file.name;
                    previewContainer.appendChild(img);
                } else if (file.type === 'pdf') {
                    const iframe = document.createElement('iframe');
                    iframe.src = file.content;
                    iframe.style.border = 'none';
                    previewContainer.appendChild(iframe);
                } else {
                    // Para otros tipos de archivo, mostrar informaci√≥n
                    const messageContainer = document.createElement('div');
                    messageContainer.className = 'file-preview-message';
                    
                    const icon = document.createElement('i');
                    icon.className = `file-icon ${getFileIcon(file.type)}`;
                    
                    const message = document.createElement('p');
                    message.textContent = `Vista previa no disponible para archivos .${file.type}. Utilice la funci√≥n de descarga para ver el contenido completo.`;
                    
                    messageContainer.appendChild(icon);
                    messageContainer.appendChild(message);
                    previewContainer.appendChild(messageContainer);
                }
                
                // Mostrar el modal
                previewModal.style.display = 'flex';
                showToast(`Vista previa de: ${file.name}`);
            } catch (error) {
                showToast('Error al cargar la vista previa', true);
                console.error('Error en vista previa:', error);
            }
        }

        // Funci√≥n para compartir archivo
        function shareFile(fileId) {
            const file = files.find(f => f.id === fileId);
            if (!file) {
                showToast('Error: Archivo no encontrado', true);
                return;
            }
            
            try {
                // Simular funcionalidad de compartir
                if (navigator.share) {
                    // Si el navegador soporta la Web Share API
                    navigator.share({
                        title: file.name,
                        text: `Compartiendo el archivo: ${file.name}\n\nDescripci√≥n: ${file.description}`,
                        url: file.content
                    })
                    .then(() => {
                        showToast('Archivo compartido exitosamente');
                    })
                    .catch(error => {
                        if (error.name !== 'AbortError') {
                            showToast('Error al compartir el archivo', true);
                        }
                    });
                } else {
                    // Alternativa para navegadores que no soportan la API
                    const shareUrl = prompt(
                        `Compartir "${file.name}"\n\nDescripci√≥n: ${file.description}\n\nCopie la URL del archivo:`, 
                        file.content
                    );
                    
                    if (shareUrl) {
                        // Intentar copiar al portapapeles
                        navigator.clipboard.writeText(file.content).then(() => {
                            showToast('Enlace copiado al portapapeles');
                        }).catch(() => {
                            showToast('Enlace listo para compartir');
                        });
                    }
                }
            } catch (error) {
                showToast('Error al compartir el archivo', true);
                console.error('Error al compartir:', error);
            }
        }

        // Funci√≥n para eliminar archivo
        async function deleteFile(fileId) {
            // Verificar permisos
            if (currentUser.role !== 'admin') {
                showToast('No tiene permisos para eliminar archivos', true);
                return;
            }
            
            const file = files.find(f => f.id === fileId);
            if (!file) {
                showToast('Error: Archivo no encontrado', true);
                return;
            }
            
            // Confirmar eliminaci√≥n
            const confirmDelete = confirm(`¬øEst√° seguro de que desea eliminar "${file.name}"?\nEsta acci√≥n no se puede deshacer.`);
            
            if (confirmDelete) {
                try {
                    // Eliminar archivo de la base de datos
                    await deleteFileFromDB(fileId);
                    
                    // Eliminar archivo del array
                    files = files.filter(f => f.id !== fileId);
                    
                    // Volver a renderizar la lista
                    renderFiles(files);
                    
                    // Mostrar mensaje de confirmaci√≥n
                    showToast(`Archivo "${file.name}" eliminado correctamente.`);
                } catch (error) {
                    showToast('Error al eliminar el archivo', true);
                    console.error('Error al eliminar:', error);
                }
            }
        }

        // Funci√≥n para obtener el icono seg√∫n el tipo de archivo
        function getFileIcon(fileType) {
            switch(fileType) {
                case 'pdf':
                    return 'fas fa-file-pdf';
                case 'doc':
                case 'docx':
                    return 'fas fa-file-word';
                case 'jpg':
                case 'png':
                case 'gif':
                    return 'fas fa-file-image';
                default:
                    return 'fas fa-file';
            }
        }

        // Funcionalidad de b√∫squeda
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // Cerrar nota activa si existe
            if (activeNote) {
                deactivateNote(activeNote);
            }
            
            if (searchTerm === '') {
                renderFiles(files);
                return;
            }
            
            const filteredFiles = files.filter(file => {
                // Buscar en los campos b√°sicos del archivo
                const basicSearch = 
                    file.name.toLowerCase().includes(searchTerm) || 
                    file.type.toLowerCase().includes(searchTerm) ||
                    file.description.toLowerCase().includes(searchTerm) ||
                    file.tags.some(tag => tag.toLowerCase().includes(searchTerm)) ||
                    file.category.toLowerCase().includes(searchTerm) ||
                    file.author.toLowerCase().includes(searchTerm);
                
                // Si ya encontramos en los campos b√°sicos, no necesitamos buscar en las notas
                if (basicSearch) return true;
                
                // Buscar en el contenido completo de la nota flotante
                const noteContent = `
                    ${file.name}
                    ${file.description}
                    ${file.category}
                    ${file.author}
                    ${file.date}
                    ${file.size}
                    ${file.tags.join(' ')}
                    ${file.type}
                `.toLowerCase();
                
                return noteContent.includes(searchTerm);
            });
            
            renderFiles(filteredFiles);
        });

        // Cerrar modal
        closeModal.addEventListener('click', () => {
            previewModal.style.display = 'none';
        });

        // Cerrar modal al hacer clic fuera del contenido
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) {
                previewModal.style.display = 'none';
            }
        });

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && previewModal.style.display === 'flex') {
                previewModal.style.display = 'none';
            }
        });

        // Cerrar nota activa al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (activeNote && !e.target.closest('.file-floating-note') && !e.target.closest('.file-card')) {
                deactivateNote(activeNote);
            }
        });

        // Manejar el formulario de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            await login(username, password);
        });

        // =============================================
        // INICIALIZACI√ìN DE LA APLICACI√ìN
        // =============================================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Inicializar base de datos
                await initDatabase();
                console.log('Base de datos inicializada correctamente');
                
                // Verificar si hay una sesi√≥n activa
                checkExistingSession();
            } catch (error) {
                console.error('Error al inicializar la aplicaci√≥n:', error);
                showToast('Error al inicializar la aplicaci√≥n', true);
            }
        });
    </script>
</body>
</html>